<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Flipbook de mi Princesa</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/alma.png">
  <style>
    :root{
      /* Solapamiento mínimo por defecto */
      --centerOverlap: 1px;
      /* iOS-only variables (se sobreescriben por clase .ios / .ios.landscape) */
      --centerOverlapIos: 1px;   /* portrait iOS */
      --centerOverlapIosLs: -36px; /* landscape iOS */
      --centerBandIos: 0px;     /* ancho banda lomo en iOS-landscape */

      /* Fallback seguro para alto de viewport en móviles */
      --vh: 1vh;
    }

    /* ===== Fondo cielo estrellado con parpadeo ===== */
    body {
      /* usar svh si existe, si no usar --vh (ajustada por JS), si no 100vh */
      min-height: 100svh;
      min-height: calc(var(--vh, 1vh) * 100);
      margin: 0;
      /* también limitar la altura máxima con unidades seguras */
      max-height: 100svh;
      max-height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
      position: relative; /* para posicionar capas ::before / ::after */
      display: flex;
      flex-direction: column;
      align-items: center;

      /* Respeta notch y barras en iOS */
      padding-left: env(safe-area-inset-left, 0);
      padding-right: env(safe-area-inset-right, 0);
      padding-top: env(safe-area-inset-top, 0);
      padding-bottom: env(safe-area-inset-bottom, 0);

      /* Fuente del sistema (común en desktop y móviles, no cursiva/ni rústica) */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
                   Arial, "Noto Sans", sans-serif;

      /* Gradiente oscuro para simular cielo */
      background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
      background-size: cover;
    }

    /* Capa 1: Estrellas fijas (densidad base) */
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        radial-gradient(2px 2px at 20px 30px, #fff, transparent),
        radial-gradient(1.5px 1.5px at 150px 80px, #fff, transparent),
        radial-gradient(2px 2px at 250px 150px, #fff, transparent),
        radial-gradient(1px 1px at 300px 300px, #fff, transparent),
        radial-gradient(1.5px 1.5px at 500px 120px, #fff, transparent),
        radial-gradient(2px 2px at 700px 200px, #fff, transparent),
        radial-gradient(1px 1px at 900px 400px, #fff, transparent),
        radial-gradient(1.5px 1.5px at 1100px 250px, #fff, transparent),
        radial-gradient(2px 2px at 1300px 100px, #fff, transparent),
        radial-gradient(1px 1px at 1500px 350px, #fff, transparent),
        radial-gradient(1px 1px at 50px 450px, #fff, transparent),
        radial-gradient(2px 2px at 400px 30px, #fff, transparent),
        radial-gradient(1.5px 1.5px at 800px 520px, #fff, transparent),
        radial-gradient(1px 1px at 1200px 600px, #fff, transparent),
        radial-gradient(2px 2px at 1400px 520px, #fff, transparent);
      background-repeat: repeat;
      background-size: 1600px 800px;
      opacity: 0.9;
    }

    /* Capa 2: Estrellas que parpadean suavemente */
    body::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background-image:
        radial-gradient(2px 2px at 80px 60px, #ffffff, transparent),
        radial-gradient(1.5px 1.5px at 220px 240px, #ffffff, transparent),
        radial-gradient(2px 2px at 360px 180px, #ffffff, transparent),
        radial-gradient(1px 1px at 520px 420px, #ffffff, transparent),
        radial-gradient(1.5px 1.5px at 680px 300px, #ffffff, transparent),
        radial-gradient(2px 2px at 860px 160px, #ffffff, transparent),
        radial-gradient(1px 1px at 1040px 500px, #ffffff, transparent),
        radial-gradient(1.5px 1.5px at 1220px 340px, #ffffff, transparent),
        radial-gradient(2px 2px at 1440px 220px, #ffffff, transparent);
      background-repeat: repeat;
      background-size: 1600px 800px;
      opacity: 0.85;
      animation: twinkle 6s infinite ease-in-out alternate,
                 drift 120s linear infinite;
    }

    @keyframes twinkle {
      0%   { opacity: 0.35; filter: drop-shadow(0 0 0px #fff); }
      50%  { opacity: 0.9;  filter: drop-shadow(0 0 2px #fff); }
      100% { opacity: 0.5;  filter: drop-shadow(0 0 0px #fff); }
    }
    @keyframes drift {
      0%   { transform: translateY(0px); }
      100% { transform: translateY(-40px); }
    }

    * { box-sizing: border-box; }

    .centered { margin: auto; width: max-content; }

    /* ===== Título del flipbook ===== */
    #flipTitle {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; /* tipografía clara y común */
      font-weight: 600;
      color: #e6ecff; /* tono claro para contrastar */
      text-align: center;
      margin-top: 1rem;
      font-size: clamp(1.2rem, 2.5vw, 2rem);
      padding: 0 1rem;
      z-index: 2;
    }
    #flipTitle small {
      font-weight: 400;
      opacity: 0.9;
    }

    /* ===== Flipbook responsivo (desktop y móviles) =====
       Ratio original 1200x720 => 5:3 */
    .flipbook {
      margin: clamp(0.75rem, 3vh, 3em) auto 1em;
      position: relative;
      transform-style: preserve-3d;
      perspective: 1000px;
      cursor: pointer; /* Interacción por clic */
      z-index: 1;      /* por encima del cielo */
      aspect-ratio: 5 / 3;
      /* Por defecto, escalar por ancho de la pantalla hasta 1200px */
      width: min(96vw, 1200px);
      height: auto;

      /* que no desborde en pantallas bajas, usando svh/--vh */
      max-height: min(82svh, 720px);
      max-height: min(calc(var(--vh) * 82), 720px);

      /* empuja al compositor (reduce artefactos en WebKit) */
      -webkit-transform: translateZ(0);
              transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    /* Si la pantalla es más baja (más “apaisada”), prioriza alto */
    @media (min-aspect-ratio: 5/3) {
      .flipbook {
        height: min(82svh, 720px);
        height: min(calc(var(--vh) * 82), 720px);
        width: calc(min(82svh, 720px) * (5/3));
        width: calc(min(calc(var(--vh) * 82), 720px) * (5/3));
      }
    }

    /* Lomo visual y tapagrietas general */
    .flipbook::after{
      content:"";
      position:absolute;
      top:0; bottom:0;
      left:50%;
      width: 2px;                 /* por defecto */
      margin-left: -1px;          /* centrado exacto */
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.28),
        rgba(255,255,255,0.08),
        rgba(0,0,0,0.28)
      );
      pointer-events:none;
      z-index: 3; /* por encima de páginas para tapar cualquier hueco */
    }

    .flipbook .leaf {
      position: absolute;
      transform-style: preserve-3d;
      height: 100%;

      /* Solape por defecto (no iOS) */
      width: calc(50% + var(--centerOverlap));
      left: calc(50% - var(--centerOverlap));

      background-color: transparent !important;
      /* === Suavidad mejorada === */
      transition: transform 0.85s cubic-bezier(0.22, 0.61, 0.36, 1);
      will-change: transform;
      transform: rotate3d(0,1,0,0deg) translateZ(0.001px); /* microZ evita antialias */
      transform-origin: left 0px;

      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      outline: 1px solid transparent; /* fuerza raster consistente en iOS */
    }

    /* Sombreado sutil durante el giro para mayor “fluidez visual” */
    .leaf.turning .page.front::after,
    .leaf.turning .page.back::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(0,0,0,0.18), rgba(0,0,0,0));
      opacity: 0.0;
      animation: leafShade 0.85s ease both;
    }
    @keyframes leafShade {
      0%   { opacity: 0.0; }
      35%  { opacity: 0.18; }
      100% { opacity: 0.0; }
    }

    /* Respeta usuarios con “reducir movimiento” */
    @media (prefers-reduced-motion: reduce) {
      .flipbook .leaf { transition: none; }
      .leaf.turning .page.front::after,
      .leaf.turning .page.back::after { animation: none; }
    }

    .flipbook .leaf .page {
      transform-style: preserve-3d;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      padding: 0;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;

      /* ayuda a WebKit a pegar bien las caras */
      -webkit-transform: translateZ(0.001px);
              transform: translateZ(0.001px);
    }

    .flipbook .leaf .page.front {
      transform: rotate3d(0,1,0,0deg) translate3d(0,0,0.1px);
      border-radius: 0em 1em 1em 0;
      left: -4%;
      height: 100%;
    }

    .flipbook .leaf .page.back {
      transform: rotate3d(0,1,0,180deg) translate3d(0,0,0.1px);
      border-radius: 1em 0em 0em 1em;
      left: -4%;
      height: 100%;
    }

    .flipbook .leaf .page img {
      display: block;
      width: 110%;
      height: 100%;
      object-fit: contain;   /* mantiene el anillado si está en la imagen */
      object-position: center;
      border-radius: inherit;
      -webkit-user-drag: none;
      user-select: none;
      pointer-events: none;
    }

    /* ===== iOS-specific: cerrar grieta con mayor solape y banda central ===== */
    .ios .flipbook .leaf {
      width: calc(50% + var(--centerOverlapIos));
      left:  calc(50% - var(--centerOverlapIos));
    }
    .ios .flipbook .leaf .page.front { /* empujón hacia el centro */
      transform: rotate3d(0,1,0,0deg) translate3d(0.5px,0,0.1px);
    }
    .ios .flipbook .leaf .page.back {
      transform: rotate3d(0,1,0,180deg) translate3d(-0.5px,0,0.1px);
    }

    .ios.landscape .flipbook .leaf {
      width: calc(50% + var(--centerOverlapIosLs));
      left:  calc(50% - var(--centerOverlapIosLs));
    }
    .ios.landscape .flipbook::after{
      width: var(--centerBandIos);
      margin-left: calc(var(--centerBandIos) / -2);
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.35),
        rgba(255,255,255,0.10),
        rgba(0,0,0,0.35)
      );
    }

    /* ===== Botón "Volver al inicio" ===== */
    #restartBtn {
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; /* tipografía clara y común */
      display: none;
      padding: 0.9em 1.25em;
      font-size: 1rem;
      border-radius: 0.75em;
      border: none;
      background: #a3bffa; /* pastel azul-lavanda que combina con el cielo */
      color: #0b1020;      /* alto contraste en fondo oscuro */
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      z-index: 1;
      transition: transform 0.15s ease, filter 0.15s ease, box-shadow 0.15s ease;
      touch-action: manipulation;

      /* mantener tu cambio: botón más arriba */
      margin-bottom: 2.5rem;
    }
    #restartBtn:hover { filter: brightness(1.05); transform: translateY(-1px); }
    #restartBtn:active { transform: translateY(0); box-shadow: 0 4px 10px rgba(0,0,0,0.25); }

    /* Botón cómodo en móviles (un poco más alto aún) */
    @media (max-width: 640px) {
      #restartBtn {
        padding: 1em 1.25em;
        font-size: 1.05rem;
        border-radius: 0.85em;
        margin-bottom: 3.5rem; /* más separación en pantallas chicas */
      }
    }
  </style>
</head>
<body>

  <!-- Título -->
  <h1 id="flipTitle">FlipAlma <small>(si estás en celular, rotá la pantalla)</small></h1>

  <div class="flipbook centered" id="flipbook">
    <!-- Hoja 1: portada + página 2 -->
    <div class="leaf">
  <div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/1.png" alt="Página 1"></div>
  <div class="page back"><img  src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/2.png" alt="Página 2"></div>
</div>

<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/3.png"  alt="Página 3"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/4.png"  alt="Página 4"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/5.png"  alt="Página 5"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/6.png"  alt="Página 6"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/7.png"  alt="Página 7"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/8.png"  alt="Página 8"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/9.png"  alt="Página 9"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/10.png" alt="Página 10"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/11.png" alt="Página 11"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/12.png" alt="Página 12"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/13.png" alt="Página 13"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/14.png" alt="Página 14"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/15.png" alt="Página 15"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/16.png" alt="Página 16"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/17.png" alt="Página 17"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/18.png" alt="Página 18"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/19.png" alt="Página 19"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/20.png" alt="Página 20"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/21.png" alt="Página 21"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/22.png" alt="Página 22"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/23.png" alt="Página 23"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/24.png" alt="Página 24"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/25.png" alt="Página 25"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/26.png" alt="Página 26"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/27.png" alt="Página 27"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/28.png" alt="Página 28"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/29.png" alt="Página 29"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/30.png" alt="Página 30"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/31.png" alt="Página 31"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/32.png" alt="Página 32"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/33.png" alt="Página 33"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/34.png" alt="Página 34"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/35.png" alt="Página 35"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/36.png" alt="Página 36"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/37.png" alt="Página 37"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/38.png" alt="Página 38"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/39.png" alt="Página 39"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/40.png" alt="Página 40"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/41.png" alt="Página 41"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/42.png" alt="Página 42"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/43.png" alt="Página 43"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/44.png" alt="Página 44"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/45.png" alt="Página 45"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/46.png" alt="Página 46"></div></div>
<div class="leaf"><div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/47.png" alt="Página 47"></div><div class="page back"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/48.png" alt="Página 48"></div></div>

<!-- Hoja final: página 49 + contraportada -->
<div class="leaf">
  <div class="page front"><img src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/49.png" alt="Página 49"></div>
  <div class="page back"><img  src="https://raw.githubusercontent.com/almayfacu/imagenes-flipbook/refs/heads/main/50.png" alt="Página 50 (Contraportada)"></div>
</div>

  </div>

  <!-- Botón visible solo cuando se llega al final -->
  <button id="restartBtn" aria-label="Volver al inicio">Volver al inicio</button>

  <!-- Sonido de pasar página: CAMBIAR src por tu archivo -->
  <audio id="pageSound" preload="auto" src="pasar.mp3"></audio>

  <script>
    /* ===== Detectar iOS y orientación para aplicar clase ===== */
    (function detectIOS(){
      const ua = window.navigator.userAgent || "";
      const iOS = /iP(hone|od|ad)/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if (iOS) document.documentElement.classList.add('ios');

      function setOrientationClass(){
        const ls = window.matchMedia("(orientation: landscape)").matches;
        document.documentElement.classList.toggle('landscape', ls);
      }
      setOrientationClass();
      window.addEventListener('orientationchange', () => setTimeout(setOrientationClass, 60));
      window.addEventListener('resize', setOrientationClass, { passive: true });
    })();

    /* ===== Fix universal de viewport para móviles (Android/iOS) =====
       - Establece --vh como 1% de window.innerHeight
       - Se recalcula en load, resize y orientationchange
    */
    function setVHVar() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVHVar();
    window.addEventListener('load', setVHVar, { passive: true });
    window.addEventListener('resize', setVHVar, { passive: true });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        setVHVar();
        // Nudge reflow del flipbook para recalcular medidas
        const fb = document.getElementById('flipbook');
        if (fb) {
          const prev = fb.style.transform;
          fb.style.transform = 'translateZ(0.0001px)';
          requestAnimationFrame(() => { fb.style.transform = prev || ''; });
        }
      }, 160);
    }, { passive: true });

    class FlipBook {
      constructor(bookElem) {
        this.elems = {
          book: bookElem,
          leaves: bookElem.querySelectorAll(".leaf"),
          restartBtn: document.getElementById("restartBtn"),
          sound: document.getElementById("pageSound")
        };
        this.currentPagePosition = 0;
        this.isAnimating = false; // evita múltiples giros simultáneos
        this.touchStartX = null;  // para gestos móviles
        this.setupEvents();
        this.turnPage(0); // inicializa posiciones y UI
      }

      setPagePosition(leaf, position, index) {
        const depth = "translateZ(2px)"; // relieve constante sin cambiar tamaño aparente
        const base = (position < 0)
          ? `${depth} rotate3d(0,1,0,-180deg)`
          : `${depth} rotate3d(0,1,0,0deg)`;

        const z = this.elems.leaves.length - Math.abs(this.currentPagePosition - index);
        leaf.style.zIndex = String(z);

        if (leaf.style.transform !== base) {
          leaf.style.transform = base;
        }

        if (position < 0) leaf.classList.add("turned");
        else leaf.classList.remove("turned");
      }

      playTurnSound() {
        try {
          const a = this.elems.sound;
          if (!a) return;
          a.pause();       // corta si estaba sonando
          a.currentTime = 0;
          a.play().catch(() => {/* ignorar bloqueo de auto-play */});
        } catch (_) {}
      }

      updateUI() {
        const atEnd = this.currentPagePosition === this.elems.leaves.length;
        this.elems.restartBtn.style.display = atEnd ? "inline-block" : "none";
      }

      /** Marca la hoja que gira para sombreado y controla el bloqueo de clics */
      markTurningLeaf_(turningIndex) {
        if (turningIndex < 0 || turningIndex >= this.elems.leaves.length) return;
        const leaf = this.elems.leaves[turningIndex];
        this.isAnimating = true;
        leaf.classList.add("turning");

        const onEnd = (e) => {
          if (e.propertyName !== "transform") return; // nos interesa sólo el fin del giro
          leaf.classList.remove("turning");
          this.isAnimating = false;
          leaf.removeEventListener("transitionend", onEnd);
        };
        leaf.addEventListener("transitionend", onEnd, { once: false });
      }

      turnPage(delta) {
        // bloquea si estamos en animación o delta es 0 (salvo inicialización)
        if (delta !== 0 && this.isAnimating) return;

        const prev = this.currentPagePosition;
        let next = prev + delta;

        if (next < 0) next = 0;
        if (next > this.elems.leaves.length) next = this.elems.leaves.length;

        if (next === prev) {
          // Nada que hacer, pero garantiza layout correcto
          this.elems.leaves.forEach((leaf, index) => {
            const pageNumber = index;
            this.setPagePosition(leaf, pageNumber - this.currentPagePosition, index);
          });
          this.updateUI();
          return;
        }

        // Determina cuál hoja realmente gira para aplicar sombreado/clase
        // - Avanzar: gira la hoja en el índice 'prev'
        // - Retroceder: “desgira” la hoja en el índice 'next'
        const turningIndex = (next > prev) ? prev : next;
        this.markTurningLeaf_(turningIndex);

        this.currentPagePosition = next;

        // Aplica transformaciones
        this.elems.leaves.forEach((leaf, index) => {
          const pageNumber = index;
          this.setPagePosition(leaf, pageNumber - this.currentPagePosition, index);
        });

        // Sonido sólo cuando realmente hay avance/retroceso
        if (delta !== 0) this.playTurnSound();

        this.updateUI();
      }

      goToStart() {
        if (this.isAnimating) return;
        this.currentPagePosition = 0;
        this.elems.leaves.forEach((leaf, index) => {
          const pageNumber = index;
          this.setPagePosition(leaf, pageNumber - this.currentPagePosition, index);
        });
        this.updateUI();
      }

      /* ===== Eventos (click, teclado y gestos táctiles) ===== */
      setupEvents() {
        // Clic: mitad izquierda → atrás, derecha → adelante
        this.elems.book.addEventListener("click", (e) => {
          if (this.isAnimating) return;
          const rect = this.elems.book.getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          if (clickX > rect.width / 2) this.turnPage(1);
          else this.turnPage(-1);
        });

        // Botón "Volver al inicio"
        this.elems.restartBtn.addEventListener("click", () => this.goToStart());

        // Teclas ← → en escritorio
        window.addEventListener("keydown", (e) => {
          if (this.isAnimating) return;
          if (e.key === "ArrowRight") this.turnPage(1);
          if (e.key === "ArrowLeft") this.turnPage(-1);
        });

        // Gestos táctiles (swipe)
        this.elems.book.addEventListener("touchstart", (e) => {
          if (this.isAnimating) return;
          const t = e.changedTouches[0];
          this.touchStartX = t.clientX;
        }, { passive: true });

        this.elems.book.addEventListener("touchend", (e) => {
          if (this.isAnimating || this.touchStartX === null) return;
          const t = e.changedTouches[0];
          const dx = t.clientX - this.touchStartX;
          const threshold = 30; // px para considerar swipe
          if (dx < -threshold) this.turnPage(1);      // swipe izquierda → avanza
          else if (dx > threshold) this.turnPage(-1); // swipe derecha → retrocede
          this.touchStartX = null;
        }, { passive: true });
      }
    }

    const flipBook = new FlipBook(document.getElementById("flipbook"));
  </script>
</body>
</html>
